#!/usr/bin/env bash
set -euo pipefail

CSV="${1:-$HOME/speedtest-logs/data/speedtest.csv}"
[ -f "$CSV" ] || { echo "CSV not found: $CSV"; exit 1; }

watch -n 10 bash -c '
  CSV="'"$CSV"'"
  clear
  echo "ðŸ“ˆ Speedtest log: $CSV"
  echo "Time: $(date)"
  echo

  echo "â€” Last 10 rows â€”"
  tail -n 10 "$CSV" | sed "s/^/  /"
  echo

  echo "â€” Mini summary (last 50 rows) â€”"
  tail -n 50 "$CSV" \
    | awk -F, "NR>1 && \$2>0 && \$3>0 { d+=\$2; u+=\$3; p+=\$5; n++ } END { 
        if(n>0) printf(\"  n=%d  avg_down=%.2f Mbps  avg_up=%.2f Mbps  avg_packet_loss=%.2f%%\\n\", n, d/n, u/n, p/n); 
        else print \"  (no rows)\" 
      }"
  echo

  echo "â€” Current inhibitors â€”"
  systemd-inhibit --list | awk '"'"'$5=="sleep"{printf "  %-28s %-7s %-10s %-18s %s\n",$1,$3,$5,$7,$8}'"'"'
'
